---
phase: 02-refund-support
plan: 04
type: execute
wave: 3
depends_on: ["02-02", "02-03"]
files_modified:
  - kalasetu-frontend/src/pages/admin/AdminSupport.jsx
  - kalasetu-frontend/src/App.jsx
autonomous: false

must_haves:
  truths:
    - "Admin can see a list of support tickets with status, priority, and category badges"
    - "Admin can filter tickets by status, category, priority, and search term"
    - "Admin can view ticket details including message thread"
    - "Admin can respond to a ticket with a public message or internal note"
    - "Admin can change ticket status (resolve/close)"
    - "Stats cards show ticket counts by status, category, and priority"
  artifacts:
    - path: "kalasetu-frontend/src/pages/admin/AdminSupport.jsx"
      provides: "Admin support ticket management page"
      min_lines: 350
    - path: "kalasetu-frontend/src/App.jsx"
      provides: "Route for /admin/support"
      contains: "AdminSupport"
  key_links:
    - from: "kalasetu-frontend/src/pages/admin/AdminSupport.jsx"
      to: "/api/admin/support/tickets"
      via: "api.get/api.post/api.patch calls"
      pattern: "api\\.(get|post|patch).*admin/support"
    - from: "kalasetu-frontend/src/App.jsx"
      to: "kalasetu-frontend/src/pages/admin/AdminSupport.jsx"
      via: "Route element import"
      pattern: "AdminSupport"
---

<objective>
Build the admin panel UI for managing support tickets: list view with filters, stats cards, ticket detail with message thread, respond/resolve/close actions. Then verify the complete Phase 2 implementation.

Purpose: Gives admins visual tools to manage support tickets from Phase 2 backend (plan 02-02). Includes a human verification checkpoint to confirm the full refund + support system works end-to-end.

Output: AdminSupport.jsx page following existing admin panel patterns, mounted in App.jsx, plus verified end-to-end functionality.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-refund-support/02-02-SUMMARY.md
@kalasetu-frontend/src/pages/admin/AdminPayments.jsx
@kalasetu-frontend/src/pages/admin/AdminRefunds.jsx
@kalasetu-frontend/src/App.jsx
@kalasetu-frontend/src/lib/axios.js
@kalasetu-frontend/src/config/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdminSupport.jsx page component + mount route</name>
  <files>
    kalasetu-frontend/src/pages/admin/AdminSupport.jsx
    kalasetu-frontend/src/App.jsx
    kalasetu-backend/controllers/adminDashboardController.js
    kalasetu-backend/routes/adminRoutes.js
  </files>
  <action>
**A. Add admin getTicketById backend endpoint (gap from plan 02-02):**

The admin backend from plan 02-02 does not have a getTicketById endpoint that returns the full ticket with messages. The list endpoint excludes messages for performance. We need a detail endpoint.

Add to `kalasetu-backend/controllers/adminDashboardController.js`:
```javascript
export const getTicketById = async (req, res) => {
  try {
    const ticket = await SupportTicket.findById(req.params.id)
      .populate('assignedTo', 'fullName email');
    if (!ticket) return res.status(404).json({ success: false, message: 'Ticket not found' });
    res.status(200).json({ success: true, data: ticket });
  } catch (error) {
    res.status(500).json({ success: false, message: 'Failed to fetch ticket' });
  }
};
```

Add to `kalasetu-backend/routes/adminRoutes.js` (AFTER the `/support/tickets/stats` route to prevent `:id` from matching "stats"):
```javascript
router.get('/support/tickets/:id', protectAdmin, checkPermission('users', 'view'), getTicketById);
```

**B. Create `kalasetu-frontend/src/pages/admin/AdminSupport.jsx`:**

Follow the same pattern as AdminPayments.jsx and AdminRefunds.jsx (same layout, Tailwind classes, brand colors).

**State variables:**
- `tickets` (array), `loading` (bool), `error` (string|null)
- `search` (string), `status` (string, default 'all'), `category` (string, default 'all'), `priority` (string, default 'all')
- `page` (number, default 1), `pagination` (object|null)
- `stats` (object|null)
- `selectedTicket` (object|null), `showDetailPanel` (bool)
- `replyMessage` (string), `isInternal` (bool, default false), `replyLoading` (bool)
- `statusChangeLoading` (bool)

**Data fetching:**
- `fetchTickets()`: GET `/api/admin/support/tickets` with params `{ page, limit: DEFAULT_PAGE_SIZE, status, category, priority, search }`.
- `fetchStats()`: GET `/api/admin/support/tickets/stats`.
- useEffect triggers both on `[page, status, category, priority, search]`.
- `fetchTicketDetail(id)`: GET `/api/admin/support/tickets/${id}` to get the full ticket including messages. Called when clicking a ticket row.

**UI Layout:**

1. **Stats cards** (top row, grid):
   - Total Tickets (stats.total)
   - Open (stats.byStatus.open) -- amber
   - In Progress (stats.byStatus.in_progress) -- blue
   - Resolved (stats.byStatus.resolved) -- green
   - Closed (stats.byStatus.closed) -- gray
   Use same card styling as AdminPayments/AdminRefunds.

2. **Filters bar:**
   - Search input (searches ticket number, subject, user name)
   - Status dropdown: all, open, in_progress, resolved, closed
   - Category dropdown: all, booking, payment, refund, technical, account, other
   - Priority dropdown: all, low, medium, high, urgent

3. **Table:**
   - Columns: Ticket #, Subject (truncated to 50 chars), Created By (name), Category (badge), Priority (badge), Status (badge), Created Date, Actions
   - Priority badges: low=gray, medium=blue, high=amber, urgent=red
   - Status badges: open=amber, in_progress=blue, resolved=green, closed=gray
   - Category badges: subtle colored pills
   - Actions: Eye icon (view detail), MessageSquare icon (respond), Check icon (resolve, only for open/in_progress), X icon (close, only for open/in_progress)
   - Loading skeleton, empty state

4. **Pagination** (same pattern as AdminPayments)

5. **Ticket Detail Panel** (slide-in panel or large modal):
   - Ticket header: number, subject, status badge, priority badge, category badge
   - Created by info: name, email, date
   - Assigned to: admin name (or "Unassigned")
   - Description section
   - **Message Thread** (most important UI element):
     - Messages displayed chronologically (oldest first)
     - Each message shows: sender name, sender role badge (User/Artisan/Admin), timestamp, message text
     - Internal notes (internal: true) shown with distinct styling (e.g., light yellow background, "Internal Note" label)
     - User messages on left, admin messages on right (chat-like layout)
   - **Reply form** at bottom:
     - Textarea for message
     - Checkbox "Internal note (not visible to user)"
     - Send button
     - On submit: POST `/api/admin/support/tickets/${id}/respond` with `{ message, internal }`
     - After success, refetch ticket detail to show new message
   - **Action buttons:**
     - "Mark as Resolved" button (if open or in_progress): PATCH `/api/admin/support/tickets/${id}/status` with `{ status: 'resolved' }`
     - "Close Ticket" button (if open, in_progress, or resolved): PATCH with `{ status: 'closed' }`
   - Close panel button

**Icons** from lucide-react: `Search, Eye, MessageSquare, Check, X, Clock, AlertTriangle, Tag, User, Shield, ChevronLeft, ChevronRight, Send, Lock`.

**C. Mount route in App.jsx:**

Add import near other admin imports:
```javascript
import AdminSupport from './pages/admin/AdminSupport';
```

Add route in admin section:
```jsx
<Route path="support" element={<AdminSupport />} />
```

**D. Update AdminLayout sidebar (if applicable):**

Check AdminLayout.jsx for sidebar nav. If it has navigation items, add "Support" link to `/admin/support` with a LifeBuoy or HeadphonesIcon. Also add "Refunds" link to `/admin/refunds` if not added by plan 02-03.

Export default AdminSupport.
  </action>
  <verify>
Run frontend lint: `cd kalasetu-frontend && npx eslint src/pages/admin/AdminSupport.jsx src/App.jsx --no-error-on-unmatched-pattern 2>&1 | head -20`

Verify App.jsx contains AdminSupport import and route.

Verify AdminSupport.jsx exists and has correct structure (stats, filters, table, detail panel, reply form).

Verify adminRoutes.js has the new GET /support/tickets/:id route.
  </verify>
  <done>
AdminSupport.jsx page exists with: stats cards (by status), filterable/searchable table, ticket detail panel with message thread (chat-like layout showing user/admin messages with role badges, internal notes highlighted), reply form with internal note toggle, resolve/close actions. Route mounted at /admin/support. Backend getTicketById endpoint added for admin detail view.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify complete Phase 2 refund and support system</name>
  <files>n/a</files>
  <action>
Human verification checkpoint for the complete Phase 2 implementation. All code has been written -- this task confirms it works end-to-end.

What was built:
- Backend: RefundRequest model, SupportTicket model, user-facing APIs, admin APIs, Razorpay webhook integration, email notifications
- Frontend: AdminRefunds page (list, filter, approve/reject), AdminSupport page (list, filter, respond, resolve/close with message thread)
- Wired stubs: contactSupport and reportIssue now create real tickets

Steps to verify:
1. Start backend: `cd kalasetu-backend && npm run dev`
2. Start frontend: `cd kalasetu-frontend && npm run dev`
3. Test Support Ticket Flow:
   a. Log in as demo user (showcase.user@kalasetu.com / Demo@1234)
   b. Navigate to profile > Help and Support tab
   c. Submit a support message -- should return success with ticket number
   d. Submit an issue report -- should return success with ticket number
   e. Log in to admin panel (showcase.admin@kalasetu.com / SuperAdmin@123)
   f. Navigate to /admin/support -- should see the two tickets in the list
   g. Click a ticket -- detail panel should show with description
   h. Send a response message -- should appear in thread
   i. Mark ticket as resolved
4. Test Admin Refunds Page:
   a. Navigate to /admin/refunds
   b. Page should load without errors (may show empty list if no refund requests exist)
   c. Stats cards should render (all zeros is fine)
   d. Filters should be interactive (status dropdown, date pickers)
5. Verify no console errors in browser dev tools on both pages
6. Verify server starts without import errors (no crash on startup)
  </action>
  <verify>
Human confirms: both admin pages render correctly, support ticket CRUD works end-to-end, no console errors.
  </verify>
  <done>
Phase 2 verified: refund backend, support backend, admin UIs all functional. User can create support tickets via Help tab. Admin can manage tickets and refund requests from admin panel.
  </done>
</task>

</tasks>

<verification>
1. AdminSupport.jsx exists with complete UI: stats, filters, table, detail panel, message thread, reply form
2. AdminSupport route is mounted at /admin/support in App.jsx
3. Backend getTicketById admin endpoint exists for detail view
4. No ESLint errors in AdminSupport.jsx
5. Human verified: both admin pages render, support ticket CRUD works, no console errors
</verification>

<success_criteria>
- AdminSupport.jsx renders stats cards, filterable table, ticket detail with message thread
- Message thread shows user/admin messages with role badges, internal notes highlighted
- Admin can respond to tickets (public and internal notes)
- Admin can resolve/close tickets
- Route accessible at /admin/support
- Full Phase 2 verified: refund backend + support backend + admin UIs all functional
</success_criteria>

<output>
After completion, create `.planning/phases/02-refund-support/02-04-SUMMARY.md`
</output>
