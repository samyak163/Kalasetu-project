---
phase: 02-refund-support
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - kalasetu-backend/models/supportTicketModel.js
  - kalasetu-backend/controllers/supportController.js
  - kalasetu-backend/routes/supportRoutes.js
  - kalasetu-backend/controllers/userAuthController.js
  - kalasetu-backend/controllers/adminDashboardController.js
  - kalasetu-backend/routes/adminRoutes.js
  - kalasetu-backend/server.js
  - kalasetu-backend/utils/email.js
autonomous: true

must_haves:
  truths:
    - "User can create a support ticket with subject, description, and category"
    - "User can view their own support tickets and ticket details"
    - "User can add messages to an open ticket"
    - "Admin can view all support tickets in a filterable list"
    - "Admin can respond to a ticket (message added, status updated to in_progress)"
    - "Admin can close or resolve a ticket"
    - "User receives email notification when admin responds or closes ticket"
    - "Existing stub endpoints (contactSupport, reportIssue) create real tickets"
  artifacts:
    - path: "kalasetu-backend/models/supportTicketModel.js"
      provides: "SupportTicket Mongoose schema with embedded messages"
      contains: "model SupportTicket"
    - path: "kalasetu-backend/controllers/supportController.js"
      provides: "User-facing support ticket CRUD"
      exports: ["createTicket", "getUserTickets", "getTicketById", "addMessage"]
    - path: "kalasetu-backend/routes/supportRoutes.js"
      provides: "REST endpoints for /api/support"
      exports: ["default"]
  key_links:
    - from: "kalasetu-backend/controllers/supportController.js"
      to: "kalasetu-backend/models/supportTicketModel.js"
      via: "Mongoose CRUD"
      pattern: "SupportTicket\\.(create|find|findById|findOne)"
    - from: "kalasetu-backend/controllers/userAuthController.js"
      to: "kalasetu-backend/controllers/supportController.js"
      via: "stub wiring imports createTicketFromStub"
      pattern: "createTicketFromStub|SupportTicket"
    - from: "kalasetu-backend/controllers/adminDashboardController.js"
      to: "kalasetu-backend/models/supportTicketModel.js"
      via: "admin ticket management"
      pattern: "SupportTicket\\.(find|findById|aggregate)"
---

<objective>
Build the complete support ticket backend: data model, user-facing API, wire existing stub endpoints, admin management API, and email notifications.

Purpose: Enables users to create support tickets, have conversations with support staff, and get resolutions. Replaces the silent-drop stubs in userAuthController.js with real ticket creation. This is the STUB-02 requirement from the roadmap.

Output: SupportTicket model, user ticket endpoints, admin ticket endpoints, wired stubs, email notifications.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-refund-support/02-RESEARCH.md
@kalasetu-backend/controllers/userAuthController.js
@kalasetu-backend/routes/userAuthRoutes.js
@kalasetu-backend/routes/adminRoutes.js
@kalasetu-backend/utils/email.js
@kalasetu-backend/utils/onesignal.js
@kalasetu-backend/models/notificationModel.js
@kalasetu-backend/server.js
@kalasetu-backend/middleware/authMiddleware.js
@kalasetu-backend/middleware/userProtectMiddleware.js
@kalasetu-backend/controllers/adminDashboardController.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: SupportTicket model + user-facing controller + routes + wire stubs</name>
  <files>
    kalasetu-backend/models/supportTicketModel.js
    kalasetu-backend/controllers/supportController.js
    kalasetu-backend/routes/supportRoutes.js
    kalasetu-backend/controllers/userAuthController.js
    kalasetu-backend/server.js
  </files>
  <action>
**1. Create `kalasetu-backend/models/supportTicketModel.js`:**

Follow the schema from 02-RESEARCH.md:

```javascript
import mongoose from 'mongoose';

const messageSchema = new mongoose.Schema({
  sender: {
    senderId: { type: mongoose.Schema.Types.ObjectId, required: true },
    senderModel: { type: String, enum: ['User', 'Artisan', 'Admin'], required: true },
    senderName: String
  },
  message: { type: String, required: true, maxlength: 5000 },
  attachments: [{
    url: String,
    filename: String,
    type: String
  }],
  internal: { type: Boolean, default: false }
}, { timestamps: true });

const supportTicketSchema = new mongoose.Schema({
  ticketNumber: { type: String, required: true, unique: true, index: true },
  subject: { type: String, required: true, maxlength: 200 },
  description: { type: String, required: true, maxlength: 5000 },
  category: {
    type: String,
    enum: ['booking', 'payment', 'refund', 'technical', 'account', 'other'],
    required: true,
    index: true
  },
  priority: {
    type: String,
    enum: ['low', 'medium', 'high', 'urgent'],
    default: 'medium',
    index: true
  },
  status: {
    type: String,
    enum: ['open', 'in_progress', 'resolved', 'closed'],
    default: 'open',
    index: true
  },
  createdBy: {
    userId: { type: mongoose.Schema.Types.ObjectId, required: true },
    userModel: { type: String, enum: ['User', 'Artisan'], required: true },
    userName: String,
    userEmail: String
  },
  assignedTo: { type: mongoose.Schema.Types.ObjectId, ref: 'Admin', index: true },
  messages: [messageSchema],
  relatedEntities: {
    booking: { type: mongoose.Schema.Types.ObjectId, ref: 'Booking' },
    payment: { type: mongoose.Schema.Types.ObjectId, ref: 'Payment' },
    refundRequest: { type: mongoose.Schema.Types.ObjectId, ref: 'RefundRequest' }
  },
  resolvedAt: Date,
  closedAt: Date,
  closedBy: {
    userId: mongoose.Schema.Types.ObjectId,
    userModel: String
  }
}, { timestamps: true });
```

Add compound indexes: `{ status: 1, priority: -1, createdAt: -1 }`, `{ category: 1, status: 1 }`, `{ assignedTo: 1, status: 1 }`, `{ 'createdBy.userId': 1, status: 1 }`.

Add a pre-save hook for auto-generating ticketNumber using `TKT-{timestamp}-{padded count}` pattern from research. Use `Date.now()` and `countDocuments()` to generate a unique number. Only set if `!this.ticketNumber`.

Export default `mongoose.model('SupportTicket', supportTicketSchema)`.

**2. Create `kalasetu-backend/controllers/supportController.js`:**

All handlers use `asyncHandler`. Use Zod for validation.

- `createTicket`: POST handler. Accepts `{ subject, description, category, priority, relatedEntities }`.
  - Validate with Zod: subject min 3 max 200, description min 10 max 5000, category must be valid enum, priority optional (default medium).
  - Create SupportTicket with `createdBy: { userId: req.user._id, userModel: req.accountType === 'artisan' ? 'Artisan' : 'User', userName: req.user.fullName, userEmail: req.user.email }`.
  - Do NOT set ticketNumber manually -- the pre-save hook handles it.
  - Create in-app Notification for user confirming ticket creation.
  - Return 201 with the created ticket.

- `getUserTickets`: GET handler. List user's tickets.
  - Query by `'createdBy.userId': req.user._id`. Support `?status=` filter and `?page=&limit=` pagination (default limit 20).
  - Exclude `messages` field from list query for performance (use `.select('-messages')`).
  - Sort by `updatedAt: -1` (most recently active first).
  - Return with pagination.

- `getTicketById`: GET handler. Single ticket with all messages.
  - Find by `_id` param. Populate `assignedTo` (select: fullName).
  - Verify `createdBy.userId` matches `req.user._id`. Return 403 if not.
  - Filter out messages where `internal: true` (admin-only notes should not be visible to users).
  - Return ticket.

- `addMessage`: POST handler for `/:id/messages`.
  - Find ticket by id. Verify ownership (`createdBy.userId === req.user._id`). Return 403 if not.
  - Check ticket status is not 'resolved' or 'closed'. Return 400 if so ("Cannot add messages to a resolved/closed ticket").
  - Check `ticket.messages.length < 100` (soft limit per research). Return 400 if exceeded.
  - Validate message body with Zod: message min 1 max 5000.
  - Push new message to `ticket.messages` array with sender info.
  - If ticket was `open`, keep it as `open` (admin response changes to in_progress, not user messages).
  - Save ticket. Return 200 with the new message.

Also export a helper `createTicketFromStub(userData, subject, description, category)` that creates a ticket programmatically (for use by the wired stubs). This function takes user data and returns the created ticket.

Export all functions as named exports.

**3. Create `kalasetu-backend/routes/supportRoutes.js`:**

```javascript
import express from 'express';
import { protectAny } from '../middleware/authMiddleware.js';
import { createTicket, getUserTickets, getTicketById, addMessage } from '../controllers/supportController.js';
const router = express.Router();

router.post('/', protectAny, createTicket);
router.get('/', protectAny, getUserTickets);
router.get('/:id', protectAny, getTicketById);
router.post('/:id/messages', protectAny, addMessage);

export default router;
```

**4. Wire existing stubs in `kalasetu-backend/controllers/userAuthController.js`:**

Replace the `contactSupport` stub (lines ~343-349) with real implementation:
```javascript
export const contactSupport = asyncHandler(async (req, res) => {
  const { subject, message, priority } = req.body;
  if (!subject || !message) {
    return res.status(400).json({ success: false, message: 'Subject and message are required' });
  }
  const SupportTicket = (await import('../models/supportTicketModel.js')).default;
  const ticket = await SupportTicket.create({
    subject,
    description: message,
    category: 'other',
    priority: priority || 'medium',
    createdBy: {
      userId: req.user._id,
      userModel: 'User',
      userName: req.user.fullName,
      userEmail: req.user.email
    }
  });
  res.status(201).json({
    success: true,
    message: 'Your support ticket has been created. We will get back to you soon.',
    data: { ticketId: ticket._id, ticketNumber: ticket.ticketNumber }
  });
});
```

Replace the `reportIssue` stub (lines ~352-358) with real implementation:
```javascript
export const reportIssue = asyncHandler(async (req, res) => {
  const { type, description } = req.body;
  if (!description) {
    return res.status(400).json({ success: false, message: 'Description is required' });
  }
  const SupportTicket = (await import('../models/supportTicketModel.js')).default;
  const categoryMap = { bug: 'technical', payment: 'payment', booking: 'booking', other: 'other' };
  const ticket = await SupportTicket.create({
    subject: `Issue Report: ${type || 'General'}`,
    description,
    category: categoryMap[type] || 'other',
    priority: 'high',
    createdBy: {
      userId: req.user._id,
      userModel: 'User',
      userName: req.user.fullName,
      userEmail: req.user.email
    }
  });
  res.status(201).json({
    success: true,
    message: 'Your issue has been reported. Our team will review it shortly.',
    data: { ticketId: ticket._id, ticketNumber: ticket.ticketNumber }
  });
});
```

Note: Use dynamic import `await import(...)` for SupportTicket model in userAuthController to avoid circular dependency issues, since userAuthController is a large file with many existing imports.

**5. Mount in `kalasetu-backend/server.js`:**

Add `import supportRoutes from './routes/supportRoutes.js';` near other route imports.
Add `app.use('/api/support', supportRoutes);` near the other route mounts (after refundRoutes if it exists, or after paymentRoutes).

Note: The existing HelpSupportTab.jsx in the frontend posts to `/api/support/contact` and `/api/support/report`. These are the stubs on userAuthRoutes at `/api/users/support/contact` and `/api/users/support/report`. These stub routes stay on userAuthRoutes (they're already wired and working). The new `/api/support` routes are the dedicated ticket management API. Both can coexist.
  </action>
  <verify>
Run `node -e "import('./kalasetu-backend/models/supportTicketModel.js').then(m => console.log('Model loaded:', !!m.default))"` from project root.

Verify supportController.js exports: `node -e "import('./kalasetu-backend/controllers/supportController.js').then(m => console.log('Exports:', Object.keys(m)))"`.

Check that server.js contains supportRoutes import and mount.

Check that userAuthController.js contactSupport and reportIssue no longer contain the `// TODO` stub comments and instead create SupportTicket documents.
  </verify>
  <done>
SupportTicket model defined with embedded messages, auto-generated ticket numbers, and proper indexes. User-facing endpoints (POST /, GET /, GET /:id, POST /:id/messages) implemented with Zod validation, ownership checks, and message limit. Existing stubs (contactSupport, reportIssue) in userAuthController.js now create real SupportTicket documents. Routes mounted at /api/support in server.js.
  </done>
</task>

<task type="auto">
  <name>Task 2: Admin support endpoints + email notifications</name>
  <files>
    kalasetu-backend/controllers/adminDashboardController.js
    kalasetu-backend/routes/adminRoutes.js
    kalasetu-backend/utils/email.js
  </files>
  <action>
**1. Add admin support functions to `kalasetu-backend/controllers/adminDashboardController.js`:**

Import SupportTicket model: `import SupportTicket from '../models/supportTicketModel.js';`
(Note: email.js, onesignal.js, and Notification model should already be imported if plan 02-01 ran first, but add them if not present.)

Add four new exported functions:

- `getAllSupportTickets`: GET handler with pagination and filters.
  - Accept query params: `{ page = 1, limit = 20, status = 'all', category = 'all', priority = 'all', search, assignedTo }`.
  - Build query. Filter by status, category, priority if not 'all'. Filter by assignedTo if provided.
  - If search provided, use `escapeRegex(search)` to match against `ticketNumber`, `subject`, `createdBy.userName`, `createdBy.userEmail` using `$or` with `$regex`.
  - Exclude `messages` from list query (`.select('-messages')`) for performance.
  - Sort by `{ status: 1, priority: -1, updatedAt: -1 }` (open first, then by priority, then most recent).
  - Apply pagination. Return `{ success: true, data: tickets, pagination: { total, page, pages } }`.

- `getSupportTicketsStats`: GET handler. Aggregate counts.
  - Count by status (open, in_progress, resolved, closed).
  - Count by category.
  - Count by priority for open+in_progress tickets only (actionable items).
  - Return stats: `{ total, byStatus: {...}, byCategory: {...}, byPriority: {...} }`.

- `respondToTicket`: POST handler for `/admin/support/tickets/:id/respond`.
  - Find ticket by id. Return 404 if not found.
  - Check ticket status is not 'resolved' or 'closed'. Return 400 if so.
  - Validate: `req.body.message` required (min 1, max 5000). Optional `req.body.internal` boolean.
  - Push message to `ticket.messages` with `sender: { senderId: req.user._id, senderModel: 'Admin', senderName: req.user.fullName }` and `internal: req.body.internal || false`.
  - If `ticket.status === 'open'`, set to `'in_progress'`.
  - If not assigned, set `ticket.assignedTo = req.user._id`.
  - Save ticket.
  - If NOT internal note, send notification to user:
    - Email via `sendEmail` with ticket response template.
    - In-app Notification.
    - Push notification via OneSignal (try/catch).
  - Return 200 with updated ticket.

- `updateTicketStatus`: PATCH handler for `/admin/support/tickets/:id/status`.
  - Accept `{ status, reason }` from body. Validate status is valid enum value.
  - Find ticket. Return 404 if not found.
  - If new status is `resolved`: set `resolvedAt = new Date()`, set `closedBy = { userId: req.user._id, userModel: 'Admin' }`.
  - If new status is `closed`: set `closedAt = new Date()`, set `closedBy`.
  - Optionally add a system message to messages array: `"Ticket ${status} by admin. ${reason || ''}"`.
  - Save ticket.
  - Notify user (email + in-app + push, try/catch).
  - Return 200 with updated ticket.

**2. Add admin support routes to `kalasetu-backend/routes/adminRoutes.js`:**

Import the four new functions from adminDashboardController.js.
Add these routes after the refund routes:

```javascript
router.get('/support/tickets', protectAdmin, checkPermission('users', 'view'), getAllSupportTickets);
router.get('/support/tickets/stats', protectAdmin, checkPermission('users', 'view'), getSupportTicketsStats);
router.post('/support/tickets/:id/respond', protectAdmin, checkPermission('users', 'view'), respondToTicket);
router.patch('/support/tickets/:id/status', protectAdmin, checkPermission('users', 'view'), updateTicketStatus);
```

Note: Use 'users' permission resource for support tickets since there's no dedicated 'support' permission in the existing system. Admin managing users can also manage their support tickets.

**3. Add support email templates to `kalasetu-backend/utils/email.js`:**

Add two new exported functions:

- `sendTicketResponseEmail(to, userName, ticket, message)`:
  HTML email following existing pattern. Use brand color `#A55233` for header. Include:
  - Ticket number in subject and header
  - Admin response text
  - CTA button "View Ticket" linking to `${EMAIL_CONFIG.appUrl}/support/tickets/${ticket._id}`
  - Footer with KalaSetu branding

- `sendTicketStatusEmail(to, userName, ticket, newStatus)`:
  HTML email for status changes (resolved, closed). Include:
  - Status-specific header: resolved = #4caf50, closed = #666
  - Ticket number and subject
  - Status change message
  - CTA to view ticket or create new one

Add both to the default export object.
  </action>
  <verify>
Verify adminDashboardController.js exports the four new support functions:
`node -e "import('./kalasetu-backend/controllers/adminDashboardController.js').then(m => { const needed = ['getAllSupportTickets','getSupportTicketsStats','respondToTicket','updateTicketStatus']; const found = needed.filter(n => typeof m[n] === 'function'); console.log('Found', found.length, 'of', needed.length); })"`

Verify adminRoutes.js contains `/support/tickets` routes.

Verify email.js exports sendTicketResponseEmail and sendTicketStatusEmail.
  </verify>
  <done>
Admin can list, filter, and search support tickets via GET /api/admin/support/tickets. Admin can view stats via GET /api/admin/support/tickets/stats. Admin can respond to a ticket (POST /api/admin/support/tickets/:id/respond) with public messages or internal notes, auto-setting status to in_progress and auto-assigning. Admin can change ticket status (PATCH /api/admin/support/tickets/:id/status) to resolved/closed. Users receive email and in-app notifications on admin responses and status changes. All notification sends are non-blocking.
  </done>
</task>

</tasks>

<verification>
1. SupportTicket model loads without errors and has correct indexes
2. User endpoints (POST/GET /api/support, GET /api/support/:id, POST /api/support/:id/messages) are mounted
3. Admin endpoints (GET/POST/PATCH /api/admin/support/tickets/*) are mounted
4. Existing stub endpoints (POST /api/users/support/contact, POST /api/users/support/report) now create real tickets
5. Ticket number auto-generates on creation
6. Messages array supports embedded messages with sender info
7. Internal notes (internal: true) are filtered from user-facing getTicketById
8. Email templates generate valid HTML
9. server.js starts without import errors
</verification>

<success_criteria>
- SupportTicket model exists with all schema fields, embedded messages, indexes, and auto-generated ticket numbers
- User can create ticket via POST /api/support with validation
- User can list their tickets via GET /api/support
- User can view ticket details via GET /api/support/:id (internal notes filtered out)
- User can add messages via POST /api/support/:id/messages (with 100-message limit)
- contactSupport and reportIssue stubs replaced with real ticket creation
- Admin can list/filter/search tickets via GET /api/admin/support/tickets
- Admin can respond to tickets with public messages or internal notes
- Admin can change ticket status (resolve/close)
- Email notifications sent on: ticket created, admin response, status change
- No new dependencies needed
</success_criteria>

<output>
After completion, create `.planning/phases/02-refund-support/02-02-SUMMARY.md`
</output>
