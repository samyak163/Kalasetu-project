---
phase: 01-critical-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - kalasetu-backend/config/multer.js
  - kalasetu-backend/routes/artisanProfileRoutes.js
  - kalasetu-backend/middleware/errorMiddleware.js
autonomous: true

must_haves:
  truths:
    - "Image uploads exceeding 10MB are rejected with 400 before reaching Cloudinary"
    - "Uploads with disallowed MIME types (e.g., .exe, .sh) are rejected with 400"
    - "Only JPEG, PNG, and WebP images are accepted for profile photo uploads"
    - "Only JPEG, PNG, WebP, and PDF files are accepted for document uploads"
    - "Valid uploads within size and type limits proceed normally"
    - "Multer errors return user-friendly JSON error messages, not raw Express errors"
  artifacts:
    - path: "kalasetu-backend/config/multer.js"
      provides: "Shared multer instances with file validation"
      contains: "imageUpload|documentUpload|fileFilter|fileSize"
    - path: "kalasetu-backend/routes/artisanProfileRoutes.js"
      provides: "Routes using validated multer instances"
      contains: "imageUpload|documentUpload"
    - path: "kalasetu-backend/middleware/errorMiddleware.js"
      provides: "Multer error handling"
      contains: "MulterError|LIMIT_FILE_SIZE"
  key_links:
    - from: "kalasetu-backend/routes/artisanProfileRoutes.js"
      to: "kalasetu-backend/config/multer.js"
      via: "import imageUpload, documentUpload"
      pattern: "import.*from.*config/multer"
    - from: "kalasetu-backend/middleware/errorMiddleware.js"
      to: "multer"
      via: "MulterError instanceof check"
      pattern: "MulterError|multer"
---

<objective>
Add file upload validation with type and size limits (BUG-03).

Purpose: Prevent malicious or oversized file uploads from reaching Cloudinary. Without validation, users can upload executables, scripts, or multi-gigabyte files that waste bandwidth and storage.

Output: New shared multer config with validated instances, updated artisan profile routes using validated uploads, and multer error handling in error middleware.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

@kalasetu-backend/routes/artisanProfileRoutes.js
@kalasetu-backend/routes/uploadRoutes.js
@kalasetu-backend/middleware/errorMiddleware.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared multer config with file validation (BUG-03)</name>
  <files>kalasetu-backend/config/multer.js</files>
  <action>
Create a new file `kalasetu-backend/config/multer.js` with validated multer instances.

```javascript
import multer from 'multer';

// Allowed MIME types
const ALLOWED_IMAGE_TYPES = ['image/jpeg', 'image/png', 'image/webp'];
const ALLOWED_DOC_TYPES = ['image/jpeg', 'image/png', 'image/webp', 'application/pdf'];

// Size limits
const MAX_IMAGE_SIZE = 10 * 1024 * 1024; // 10MB
const MAX_DOC_SIZE = 10 * 1024 * 1024;   // 10MB

/**
 * Multer instance for image uploads (profile photos, portfolio images).
 * Accepts: JPEG, PNG, WebP. Max: 10MB.
 */
export const imageUpload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: MAX_IMAGE_SIZE },
  fileFilter: (_req, file, cb) => {
    if (ALLOWED_IMAGE_TYPES.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new multer.MulterError('LIMIT_UNEXPECTED_FILE', file.fieldname));
    }
  },
});

/**
 * Multer instance for document uploads (Aadhar, PAN, police verification, etc.).
 * Accepts: JPEG, PNG, WebP, PDF. Max: 10MB.
 */
export const documentUpload = multer({
  storage: multer.memoryStorage(),
  limits: { fileSize: MAX_DOC_SIZE },
  fileFilter: (_req, file, cb) => {
    if (ALLOWED_DOC_TYPES.includes(file.mimetype)) {
      cb(null, true);
    } else {
      cb(new multer.MulterError('LIMIT_UNEXPECTED_FILE', file.fieldname));
    }
  },
});
```

Key details:
- Use `multer.MulterError` in fileFilter so the error middleware can distinguish validation errors from other errors.
- Document uploads include PDF since artisans upload identity documents (Aadhar, PAN, licenses).
- Both use `memoryStorage()` to match the existing pattern in artisanProfileRoutes.js.
- No video upload instance needed yet (uploadRoutes.js is signature-only for direct Cloudinary uploads, not server-side).
  </action>
  <verify>
1. Confirm file exists at `kalasetu-backend/config/multer.js`.
2. Confirm it exports `imageUpload` and `documentUpload`.
3. Run `node -c kalasetu-backend/config/multer.js` to verify syntax.
  </verify>
  <done>
Shared multer config created with `imageUpload` (JPEG/PNG/WebP, 10MB max) and `documentUpload` (JPEG/PNG/WebP/PDF, 10MB max). Both use memoryStorage and MulterError for rejected files.
  </done>
</task>

<task type="auto">
  <name>Task 2: Update artisan profile routes to use validated multer + add error handling (BUG-03)</name>
  <files>kalasetu-backend/routes/artisanProfileRoutes.js, kalasetu-backend/middleware/errorMiddleware.js</files>
  <action>
**Part A: Update artisanProfileRoutes.js**

1. Replace the local multer setup with imports from the shared config:

Remove these lines:
```javascript
import multer from 'multer';
// ... (line 25-26)
const storage = multer.memoryStorage();
const upload = multer({ storage });
```

Add this import (after the existing imports):
```javascript
import { imageUpload, documentUpload } from '../config/multer.js';
```

2. Update the profile photo route (line 59) — replace `upload.single('image')` with `imageUpload.single('image')`:
```javascript
router.post(
  '/profile/photo',
  protect,
  imageUpload.single('image'),
  toTempFile,
  invalidateCache(['cache:artisan:profile*','cache:artisans:public*']),
  uploadProfilePhoto
);
```

3. Update the document upload route (line 91) — replace `upload.single('file')` with `documentUpload.single('file')`:
```javascript
router.post(
  '/profile/documents/upload',
  protect,
  documentUpload.single('file'),
  toTempFile,
  invalidateCache(['cache:artisan:profile*']),
  uploadDocument
);
```

4. Keep the `toTempFile` middleware and all its imports (`fs`, `os`, `path`) — it's still needed.

**Part B: Add Multer error handling to errorMiddleware.js**

Read the existing `errorMiddleware.js` and add MulterError handling BEFORE the generic error handler.

Add at the top of the file:
```javascript
import multer from 'multer';
```

In the error handler function, add a check for MulterError BEFORE the generic error response:

```javascript
// Handle Multer file upload errors
if (err instanceof multer.MulterError) {
  let message = 'File upload error';
  let statusCode = 400;

  switch (err.code) {
    case 'LIMIT_FILE_SIZE':
      message = 'File is too large. Maximum size is 10MB.';
      break;
    case 'LIMIT_UNEXPECTED_FILE':
      message = 'Invalid file type. Only images (JPEG, PNG, WebP) and PDF documents are allowed.';
      break;
    case 'LIMIT_FILE_COUNT':
      message = 'Too many files uploaded.';
      break;
    default:
      message = `Upload error: ${err.message}`;
  }

  return res.status(statusCode).json({ success: false, message });
}
```

Also handle the case where multer's fileFilter throws a plain Error (not MulterError):
```javascript
// Handle multer fileFilter errors thrown as plain Error
if (err.message && err.message.includes('Invalid file type')) {
  return res.status(400).json({ success: false, message: err.message });
}
```

This ensures users get clear JSON error messages instead of raw HTML error pages when uploads fail validation.
  </action>
  <verify>
1. Read `artisanProfileRoutes.js` and confirm:
   - No local `multer` import or `const upload = multer(...)` remains
   - `imageUpload` and `documentUpload` are imported from `../config/multer.js`
   - Profile photo route uses `imageUpload.single('image')`
   - Document upload route uses `documentUpload.single('file')`
   - `toTempFile` middleware and its imports are preserved
2. Read `errorMiddleware.js` and confirm:
   - `multer` is imported
   - `MulterError` check exists with appropriate switch cases
   - Error responses use `{ success: false, message }` format
3. Run `node -c kalasetu-backend/routes/artisanProfileRoutes.js && node -c kalasetu-backend/middleware/errorMiddleware.js` to verify syntax.
  </verify>
  <done>
Artisan profile routes use validated multer instances. Profile photos accept only JPEG/PNG/WebP up to 10MB. Document uploads accept JPEG/PNG/WebP/PDF up to 10MB. Multer errors are caught by the error middleware and returned as user-friendly JSON responses. The uploadRoutes.js signature endpoint is unchanged (it does not handle file uploads server-side — it returns a Cloudinary signature for client-side direct upload, so server-side multer validation is not applicable there).
  </done>
</task>

</tasks>

<verification>
1. Syntax check: `node -c kalasetu-backend/config/multer.js && node -c kalasetu-backend/routes/artisanProfileRoutes.js && node -c kalasetu-backend/middleware/errorMiddleware.js`
2. Confirm `imageUpload` and `documentUpload` are exported from config/multer.js.
3. Confirm no unvalidated `multer({ storage })` instances remain in artisanProfileRoutes.js.
4. Confirm errorMiddleware.js handles `MulterError` with user-friendly messages.
5. Confirm uploadRoutes.js is NOT modified (it's a signature endpoint, not a file upload endpoint).
</verification>

<success_criteria>
- New config/multer.js exports `imageUpload` (images only, 10MB) and `documentUpload` (images + PDF, 10MB).
- artisanProfileRoutes.js uses `imageUpload` for photo and `documentUpload` for documents.
- errorMiddleware.js returns JSON error messages for multer validation failures (not raw HTML).
- uploadRoutes.js (Cloudinary signature) is unchanged.
- All files pass syntax check.
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-03-SUMMARY.md`
</output>
