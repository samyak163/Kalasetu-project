---
phase: 01-critical-bug-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - kalasetu-frontend/src/context/NotificationContext.jsx
  - kalasetu-frontend/src/components/search/AdvancedFilters.jsx
  - kalasetu-frontend/src/pages/RegisterPage.jsx
  - kalasetu-frontend/src/pages/UserRegisterPage.jsx
autonomous: true

must_haves:
  truths:
    - "NotificationContext makes exactly one API call on mount, then only refetches on explicit triggers"
    - "No infinite loop of network requests from NotificationContext"
    - "Errors in AdvancedFilters facet loading are reported to Sentry"
    - "Errors in RegisterPage and UserRegisterPage notification refresh are reported to Sentry"
    - "No empty catch blocks remain in the three BUG-05 files"
  artifacts:
    - path: "kalasetu-frontend/src/context/NotificationContext.jsx"
      provides: "Stable refresh callback via useRef pattern"
      contains: "useRef|refreshRef"
    - path: "kalasetu-frontend/src/components/search/AdvancedFilters.jsx"
      provides: "Sentry error reporting for facet load failure"
      contains: "captureException"
    - path: "kalasetu-frontend/src/pages/RegisterPage.jsx"
      provides: "Sentry error reporting for notification refresh failure"
      contains: "captureException"
    - path: "kalasetu-frontend/src/pages/UserRegisterPage.jsx"
      provides: "Sentry error reporting for notification refresh failure"
      contains: "captureException"
  key_links:
    - from: "kalasetu-frontend/src/context/NotificationContext.jsx"
      to: "/api/notifications"
      via: "axios.get in refreshRef.current"
      pattern: "refreshRef\\.current"
    - from: "kalasetu-frontend/src/components/search/AdvancedFilters.jsx"
      to: "kalasetu-frontend/src/lib/sentry.js"
      via: "captureException import"
      pattern: "import.*captureException.*from.*sentry"
---

<objective>
Fix the NotificationContext infinite refresh loop (BUG-02) and replace empty catch blocks with Sentry error reporting (BUG-05).

Purpose: Prevent runaway API calls that degrade performance and user experience. Ensure errors are tracked in Sentry instead of being silently swallowed, enabling debugging of production issues.

Output: Fixed NotificationContext.jsx with useRef pattern, updated AdvancedFilters.jsx, RegisterPage.jsx, and UserRegisterPage.jsx with proper error handling.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-bug-fixes/01-RESEARCH.md

@kalasetu-frontend/src/context/NotificationContext.jsx
@kalasetu-frontend/src/components/search/AdvancedFilters.jsx
@kalasetu-frontend/src/pages/RegisterPage.jsx
@kalasetu-frontend/src/pages/UserRegisterPage.jsx
@kalasetu-frontend/src/lib/sentry.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix NotificationContext infinite refresh loop with useRef pattern (BUG-02)</name>
  <files>kalasetu-frontend/src/context/NotificationContext.jsx</files>
  <action>
Rewrite `NotificationContext.jsx` to use the `useRef` pattern that prevents the infinite loop.

**Root cause:** `refresh` is a `useCallback` that depends on `computeUnread` and `formatTimeAgo`. The `useEffect` at line 56 has `[refresh]` in its dependency array. When `refresh` runs, it calls `setNotifications` and `setUnreadCount`, which trigger a re-render. On re-render, `refresh` is recreated (even though deps are stable `useCallback`s), which triggers the `useEffect` again, causing an infinite loop.

**Fix:**

1. Add `useRef` to the React import: `import React, { createContext, useContext, useEffect, useState, useCallback, useRef } from 'react';`

2. Replace the current `refresh` `useCallback` and `useEffect` with:

```javascript
// Store refresh implementation in ref to prevent identity changes
const refreshRef = useRef();

refreshRef.current = async () => {
  try {
    const res = await axios.get(`${API_CONFIG.BASE_URL}/api/notifications`, { withCredentials: true });
    const list = Array.isArray(res.data) ? res.data : (res.data?.data || []);
    const decorated = list.map((item) => ({
      ...item,
      timeAgo: formatTimeAgo(item.createdAt),
    }));
    setNotifications(decorated);
    setUnreadCount(computeUnread(decorated));
  } catch (err) {
    console.error('Failed to refresh notifications:', err);
  }
};

// Stable reference that never changes identity
const refresh = useCallback(() => refreshRef.current(), []);

// ... markRead useCallback stays as-is ...

// Fetch once on mount - empty deps, no infinite loop
useEffect(() => {
  refreshRef.current();
}, []);
```

Key details:
- `refreshRef.current` is reassigned on every render (intentionally), so it always has the latest closure values.
- `refresh` is a stable `useCallback` with `[]` deps that delegates to `refreshRef.current()` — its identity never changes.
- The `useEffect` calls `refreshRef.current()` directly with empty deps `[]`, running exactly once on mount.
- External callers (e.g., RegisterPage) still call `refresh()` which delegates to `refreshRef.current()`.
- The `markRead` callback stays unchanged.
  </action>
  <verify>
1. Read the modified file and confirm:
   - `useRef` is imported from React
   - `refreshRef` is declared with `useRef()`
   - `refreshRef.current` is assigned the async function (without useCallback wrapping)
   - `refresh` is `useCallback(() => refreshRef.current(), [])`
   - `useEffect` has empty dependency array `[]`
   - `useEffect` calls `refreshRef.current()` (not `refresh()`)
   - No `[refresh]` dependency array anywhere
2. Run `npx -y acorn --ecma2020 --module --allow-import-export-everywhere kalasetu-frontend/src/context/NotificationContext.jsx` or use the Vite dev server to verify no syntax errors.
  </verify>
  <done>
NotificationContext makes exactly one API call on mount via `refreshRef.current()`. The `refresh` function exposed to consumers is a stable reference that never triggers re-renders. No infinite loop possible because useEffect has empty deps `[]`.
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace empty catch blocks with Sentry error reporting (BUG-05)</name>
  <files>kalasetu-frontend/src/components/search/AdvancedFilters.jsx, kalasetu-frontend/src/pages/RegisterPage.jsx, kalasetu-frontend/src/pages/UserRegisterPage.jsx</files>
  <action>
Replace all three empty catch blocks with proper Sentry error reporting. The project already has `captureException` in `lib/sentry.js`.

**File 1: AdvancedFilters.jsx (line 17)**

Current: `} catch (err) { if (import.meta.env.DEV) console.error('Failed to load search facets:', err); }`

1. Add import at top: `import { captureException } from '../../lib/sentry.js';`
2. Replace catch block:
```javascript
} catch (err) {
  captureException(err, { context: 'search_facets_load', component: 'AdvancedFilters' });
  if (import.meta.env.DEV) console.error('Failed to load search facets:', err);
}
```
Note: No toast needed here — facet loading failure is non-critical (filters just won't populate, search still works).

**File 2: RegisterPage.jsx (line 63-65)**

Current: `try { await refreshNotifications(); } catch (_) {}`

1. Add import at top: `import { captureException } from '../lib/sentry.js';`
   (Note: `ToastContext` and `showToast` are already imported and available)
2. Replace the empty catch block:
```javascript
try {
  await refreshNotifications();
} catch (err) {
  captureException(err, { context: 'post_registration_notification_refresh', component: 'RegisterPage' });
}
```
Note: No toast needed — notification refresh failure after registration is non-critical (user has already registered successfully and is being redirected).

**File 3: UserRegisterPage.jsx (line 68-70)**

Current: `try { await refreshNotifications(); } catch (_) {}`

1. Add import at top: `import { captureException } from '../lib/sentry.js';`
2. Replace the empty catch block:
```javascript
try {
  await refreshNotifications();
} catch (err) {
  captureException(err, { context: 'post_registration_notification_refresh', component: 'UserRegisterPage' });
}
```
Same rationale as RegisterPage — non-critical, just log to Sentry.

For all three files:
- Use `err` as the catch variable name (not `_`), since the error is now used.
- The `captureException` call includes a `context` object for Sentry grouping and a `component` field for identification.
- Keep the existing `console.error` in AdvancedFilters for dev mode debugging.
  </action>
  <verify>
1. Read all three files and confirm:
   - `captureException` is imported from the correct relative path to `lib/sentry.js`
   - No empty catch blocks (`catch (_) {}`) remain
   - Each catch block calls `captureException(err, { context: '...', component: '...' })`
   - AdvancedFilters still has the DEV console.error
   - RegisterPage and UserRegisterPage use `err` not `_` as catch param
2. Run `grep -rn "catch (_)" kalasetu-frontend/src/components/search/AdvancedFilters.jsx kalasetu-frontend/src/pages/RegisterPage.jsx kalasetu-frontend/src/pages/UserRegisterPage.jsx` to verify no empty catches remain.
  </verify>
  <done>
All three empty catch blocks replaced with Sentry error reporting via `captureException`. Errors are logged to Sentry with component context for debugging. No user-facing toasts added since all three failures are non-critical (filters not populating, post-registration notification refresh). ESLint empty-catch-block errors resolved.
  </done>
</task>

</tasks>

<verification>
1. Confirm no `catch (_) {}` patterns remain in the three BUG-05 files.
2. Confirm `captureException` is imported in all three BUG-05 files.
3. Confirm NotificationContext.jsx uses `useRef` and has empty dependency array on the mount useEffect.
4. Confirm no `[refresh]` dependency array exists in NotificationContext.jsx.
5. Syntax check: Files should not have JSX syntax errors (verify via reading).
</verification>

<success_criteria>
- NotificationContext.jsx uses useRef pattern with empty deps useEffect. No infinite loop.
- AdvancedFilters.jsx catch block calls captureException + keeps DEV console.error.
- RegisterPage.jsx catch block calls captureException instead of empty catch.
- UserRegisterPage.jsx catch block calls captureException instead of empty catch.
- Zero `catch (_) {}` patterns remain in the codebase.
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-bug-fixes/01-02-SUMMARY.md`
</output>
