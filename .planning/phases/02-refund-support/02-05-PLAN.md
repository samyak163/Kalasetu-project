---
phase: 02-refund-support
plan: 05
type: execute
wave: 4
depends_on: ["02-01", "02-03"]
gap_closure: true
files_modified:
  - kalasetu-frontend/src/components/profile/tabs/OrderHistoryTab.jsx
autonomous: true

must_haves:
  truths:
    - "Completed bookings with captured payments show a Request Refund button"
    - "Clicking Request Refund opens a modal pre-filled with booking/payment info"
    - "User selects a reason from a dropdown and optionally adds notes"
    - "After submission, the order card shows refund status badge"
    - "Orders with existing refund requests show their current status"
  artifacts:
    - path: "kalasetu-frontend/src/components/profile/tabs/OrderHistoryTab.jsx"
      provides: "Refund request button and modal on order cards"
      contains: "Request Refund"
  key_links:
    - from: "kalasetu-frontend/src/components/profile/tabs/OrderHistoryTab.jsx"
      to: "/api/refunds"
      via: "api.post for creating refund, api.get for checking existing"
      pattern: "api\\.(post|get).*refunds"
---

<objective>
Add a "Request Refund" button to completed order cards in OrderHistoryTab with a pre-filled refund modal. Users pick a reason from a dropdown + optional notes instead of navigating elsewhere. Also show refund status on orders that have existing requests.

Purpose: Users currently have no frontend path to request refunds. The backend API exists (plan 02-01) but there's no UI entry point. This puts the refund button exactly where users expect it — on their order.

Output: Enhanced OrderHistoryTab.jsx with refund button, refund modal, and refund status badges.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@kalasetu-frontend/src/components/profile/tabs/OrderHistoryTab.jsx
@kalasetu-backend/controllers/refundController.js
@kalasetu-backend/models/paymentModel.js
@kalasetu-frontend/src/lib/axios.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add refund button, modal, and status to OrderHistoryTab</name>
  <files>
    kalasetu-frontend/src/components/profile/tabs/OrderHistoryTab.jsx
  </files>
  <action>
Enhance `OrderHistoryTab.jsx` with refund functionality. This is a single-file change.

**1. New state variables:**
- `showRefundModal` (bool)
- `refundOrder` (object|null) — the order being refunded
- `refundReason` (string)
- `refundNotes` (string)
- `refundLoading` (bool)
- `refundRequests` (object) — map of bookingId → refund status/info

**2. Fetch existing refund requests on mount:**
Add a `fetchRefundRequests` function that calls `GET /api/refunds` to get the user's refund requests. Build a lookup map: `{ [bookingId]: { status, amount, _id } }` from the response. Call this alongside `fetchOrders` in the useEffect. This lets us show refund status on order cards.

**3. Add "Request Refund" button to order cards:**
In the action buttons section (line ~218), add a new button after the existing ones:

```jsx
{order.status === 'completed' && !refundRequests[order._id] && (
  <button
    onClick={() => openRefundModal(order)}
    className="px-4 py-2 border border-amber-300 text-amber-700 rounded-lg hover:bg-amber-50 transition-colors text-sm"
  >
    Request Refund
  </button>
)}
```

Show the button for `completed` orders that don't already have a refund request. The order needs to have an associated payment with status `captured`.

**4. Show refund status badge on orders with existing requests:**
Above or near the status badge, if `refundRequests[order._id]` exists, show a small refund status indicator:

```jsx
{refundRequests[order._id] && (
  <span className={`inline-block px-2 py-1 rounded text-xs font-medium mt-1 ${getRefundStatusColor(refundRequests[order._id].status)}`}>
    Refund: {refundRequests[order._id].status.replace('_', ' ')}
  </span>
)}
```

Add `getRefundStatusColor` helper: pending=amber, processing=blue, processed=green, rejected=red, failed=red.

**5. Refund modal:**
Add a modal component (inline, not a separate file) that appears when `showRefundModal` is true:

```jsx
{showRefundModal && refundOrder && (
  <div className="fixed inset-0 bg-black/50 flex items-center justify-center z-50 p-4">
    <div className="bg-white dark:bg-gray-800 rounded-xl max-w-md w-full p-6 shadow-xl">
      <div className="flex justify-between items-center mb-4">
        <h3 className="text-lg font-bold text-gray-900 dark:text-white">Request Refund</h3>
        <button onClick={closeRefundModal} className="text-gray-400 hover:text-gray-600">
          <X className="h-5 w-5" />
        </button>
      </div>

      {/* Pre-filled order info (read-only) */}
      <div className="bg-gray-50 dark:bg-gray-700 rounded-lg p-3 mb-4 text-sm">
        <p><span className="font-medium">Service:</span> {refundOrder.serviceName}</p>
        <p><span className="font-medium">Artisan:</span> {refundOrder.artisan?.fullName}</p>
        <p><span className="font-medium">Amount:</span> ₹{refundOrder.price?.toLocaleString()}</p>
        <p><span className="font-medium">Date:</span> {new Date(refundOrder.createdAt).toLocaleDateString()}</p>
      </div>

      {/* Reason dropdown */}
      <div className="mb-4">
        <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
          Reason for refund
        </label>
        <select value={refundReason} onChange={e => setRefundReason(e.target.value)}
          className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-500 dark:bg-white dark:text-gray-900">
          <option value="">Select a reason...</option>
          <option value="Service not as described">Service not as described</option>
          <option value="Poor quality of work">Poor quality of work</option>
          <option value="Artisan did not show up">Artisan did not show up</option>
          <option value="Service not completed">Service not completed</option>
          <option value="Duplicate payment">Duplicate payment</option>
          <option value="Changed my mind">Changed my mind</option>
          <option value="Other">Other</option>
        </select>
      </div>

      {/* Optional notes */}
      <div className="mb-4">
        <label className="block text-sm font-semibold text-gray-700 dark:text-gray-300 mb-2">
          Additional details (optional)
        </label>
        <textarea value={refundNotes} onChange={e => setRefundNotes(e.target.value)}
          rows={3} maxLength={1000} placeholder="Provide any additional context..."
          className="w-full px-4 py-3 border border-gray-300 dark:border-gray-600 rounded-lg focus:ring-2 focus:ring-brand-500 dark:bg-white dark:text-gray-900 resize-none" />
      </div>

      {/* Submit */}
      <div className="flex gap-3">
        <button onClick={closeRefundModal}
          className="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 text-sm font-medium">
          Cancel
        </button>
        <button onClick={handleSubmitRefund} disabled={!refundReason || refundLoading}
          className="flex-1 px-4 py-3 bg-brand-500 text-white rounded-lg hover:bg-brand-600 disabled:opacity-50 text-sm font-medium">
          {refundLoading ? 'Submitting...' : 'Submit Request'}
        </button>
      </div>
    </div>
  </div>
)}
```

**6. Handler functions:**

- `openRefundModal(order)`: Set `refundOrder = order`, `showRefundModal = true`, reset reason and notes.
- `closeRefundModal()`: Reset all refund modal state.
- `handleSubmitRefund()`:
  - Set refundLoading = true.
  - Need the paymentId for this order. Fetch it: `GET /api/bookings/${refundOrder._id}` may include payment info, OR we look it up. Since the booking may not have paymentId directly, call `GET /api/payments?bookingId=${refundOrder._id}` if available.
  - Alternative simpler approach: The refund API accepts paymentId. We need to find the payment for this booking. Check if `refundOrder.payment` or `refundOrder.paymentId` exists in the order data. If not, call `GET /api/bookings/${refundOrder._id}` first to get payment info.
  - Actually, the simplest approach: the order data from `/api/bookings/me` may include a `payment` or `paymentId` field. Check the booking model to see. If not, we can search payments by booking.
  - POST `/api/refunds` with `{ paymentId, amount: refundOrder.price, reason: refundReason + (refundNotes ? '\n' + refundNotes : '') }`.
  - On success: showToast success, close modal, refetch refund requests to update badges.
  - On error: showToast with error message from API response.

**Important note about paymentId:** The order data from `GET /api/bookings/me` may not include the payment ID directly. Check what the booking response includes. If it doesn't include payment info, we need to find it. Options:
  a. If the Booking model has a `payment` field — use it directly.
  b. If not, add a step where we fetch the payment by booking: `GET /api/payments?bookingId=xxx` or search.
  c. Simplest: modify the refund API to accept `bookingId` instead of `paymentId`, and do the lookup server-side.

For now, implement option (a) first. If the booking data has `payment` or `paymentId`, use it. If not at runtime (field is undefined), show a toast "Unable to find payment for this booking. Please contact support." — graceful fallback.

**7. Import X from lucide-react** (for close button in modal).

**8. Do NOT change the existing page structure, filters, stats, or other functionality.** Only add the refund button, modal, and status display.
  </action>
  <verify>
Check that OrderHistoryTab.jsx:
- Contains "Request Refund" button text
- Contains refund modal with reason dropdown
- Contains `fetchRefundRequests` function
- Contains `handleSubmitRefund` function
- Has `getRefundStatusColor` helper
- Imports X from lucide-react

Run lint: `cd kalasetu-frontend && npx eslint src/components/profile/tabs/OrderHistoryTab.jsx --no-error-on-unmatched-pattern 2>&1 | head -20`
  </verify>
  <done>
OrderHistoryTab shows "Request Refund" button on completed orders with captured payments. Pre-filled modal with order info, reason dropdown, and optional notes. Existing refund requests shown as status badges on order cards. Refund API called with correct payload. Graceful error handling.
  </done>
</task>

</tasks>

<verification>
1. "Request Refund" button appears on completed orders without existing refund requests
2. Modal opens pre-filled with order info (service, artisan, amount, date)
3. Reason dropdown has relevant refund reasons
4. Submit calls POST /api/refunds with correct payload
5. After submission, order card shows refund status badge
6. Orders with existing refund requests show their current status
7. No ESLint errors
</verification>

<success_criteria>
- Request Refund button visible on completed orders
- Pre-filled modal with reason dropdown + optional notes
- Refund status badges on orders with existing requests
- Proper error handling and loading states
- No changes to existing OrderHistoryTab functionality
</success_criteria>

<output>
After completion, create `.planning/phases/02-refund-support/02-05-SUMMARY.md`
</output>
