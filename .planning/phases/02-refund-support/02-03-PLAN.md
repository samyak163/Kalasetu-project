---
phase: 02-refund-support
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - kalasetu-frontend/src/pages/admin/AdminRefunds.jsx
  - kalasetu-frontend/src/App.jsx
autonomous: true

must_haves:
  truths:
    - "Admin can see a list of refund requests with status badges and filters"
    - "Admin can filter refunds by status, date range, and search term"
    - "Admin can view refund request details in a modal"
    - "Admin can approve a pending refund request"
    - "Admin can reject a pending refund request with a reason"
    - "Stats cards show refund counts and amounts by status"
  artifacts:
    - path: "kalasetu-frontend/src/pages/admin/AdminRefunds.jsx"
      provides: "Admin refund management page"
      min_lines: 300
    - path: "kalasetu-frontend/src/App.jsx"
      provides: "Route for /admin/refunds"
      contains: "AdminRefunds"
  key_links:
    - from: "kalasetu-frontend/src/pages/admin/AdminRefunds.jsx"
      to: "/api/admin/refunds"
      via: "api.get/api.post calls"
      pattern: "api\\.(get|post).*admin/refunds"
    - from: "kalasetu-frontend/src/App.jsx"
      to: "kalasetu-frontend/src/pages/admin/AdminRefunds.jsx"
      via: "Route element import"
      pattern: "AdminRefunds"
---

<objective>
Build the admin panel UI for managing refund requests: list view with filters, stats cards, detail modal, and approve/reject actions.

Purpose: Gives admins visual tools to manage the refund workflow from Phase 2 backend (plan 02-01). Without this UI, admin API endpoints have no frontend.

Output: AdminRefunds.jsx page following existing admin panel patterns (AdminPayments.jsx), mounted in App.jsx admin routes.
</objective>

<execution_context>
@C:/Users/Lenovo/.claude/get-shit-done/workflows/execute-plan.md
@C:/Users/Lenovo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-refund-support/02-01-SUMMARY.md
@kalasetu-frontend/src/pages/admin/AdminPayments.jsx
@kalasetu-frontend/src/App.jsx
@kalasetu-frontend/src/lib/axios.js
@kalasetu-frontend/src/config/constants.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: AdminRefunds.jsx page component</name>
  <files>
    kalasetu-frontend/src/pages/admin/AdminRefunds.jsx
  </files>
  <action>
Create `kalasetu-frontend/src/pages/admin/AdminRefunds.jsx` following the exact pattern of AdminPayments.jsx (same layout, same component structure, same Tailwind classes, same brand colors).

**Component structure:**

State variables:
- `refunds` (array), `loading` (bool), `error` (string|null)
- `search` (string), `status` (string, default 'all'), `startDate` (string), `endDate` (string)
- `page` (number, default 1), `pagination` (object|null)
- `stats` (object|null)
- `selectedRefund` (object|null), `showModal` (bool)
- `actionLoading` (bool) -- for approve/reject button loading state
- `rejectReason` (string) -- for reject modal input

**Data fetching:**
- `fetchRefunds()`: GET `/api/admin/refunds` with params `{ page, limit: DEFAULT_PAGE_SIZE, status, startDate, endDate, search }`. Same pattern as AdminPayments fetchPayments. Use `DEFAULT_PAGE_SIZE` and `SKELETON_ROWS` from constants.
- `fetchStats()`: GET `/api/admin/refunds/stats`.
- useEffect triggers both on `[page, status, startDate, endDate, search]`.

**Actions:**
- `handleApprove(id)`: Show confirmation dialog. POST `/api/admin/refunds/${id}/approve`. On success, refetch list and stats. Show success alert.
- `handleReject(id)`: Show a small inline form/prompt for reason. POST `/api/admin/refunds/${id}/reject` with `{ reason }`. On success, refetch. Show success alert.
- `handleViewDetails(refund)`: Open detail modal.

**UI Layout (follow AdminPayments pattern exactly):**

1. **Stats cards** (top row, grid of 4-5 cards):
   - Total Requests (from stats.total)
   - Pending (stats.pending) -- amber/yellow badge
   - Processing (stats.processing) -- blue badge
   - Processed/Completed (stats.processed) -- green badge
   - Rejected (stats.rejected) -- red badge
   Use the same card styling: `bg-white rounded-xl shadow-sm border p-6`.

2. **Filters bar** (below stats):
   - Search input with Search icon (lucide-react)
   - Status dropdown: all, pending, approved, processing, processed, rejected, failed
   - Start date and End date inputs
   - Use same Tailwind classes as AdminPayments filters

3. **Table** (main content):
   - Columns: ID (truncated), Requester (name + email), Payment ID, Amount (formatted INR), Status (badge), Requested Date, Actions
   - Status badges with colors: pending=amber, approved=blue, processing=blue, processed=green, rejected=red, failed=red. Use same badge pattern as AdminPayments.
   - Actions column: Eye icon (view details), CheckCircle icon (approve, only for pending), XCircle icon (reject, only for pending).
   - Loading skeleton using `SKELETON_ROWS`.
   - Empty state when no results.

4. **Pagination** (bottom):
   - Use `getPaginationRange` from constants.
   - Same pagination UI pattern as AdminPayments.

5. **Detail Modal** (when selectedRefund is set):
   - Show full refund details: requester info, payment info, amount, reason, evidence list, status timeline, admin response if exists.
   - Approve/Reject buttons at bottom (only for pending status).
   - Reject button shows a textarea for reason input.
   - Close button (X icon).
   - Use same modal overlay pattern as AdminPayments.

**Brand colors:** Use `brand-*` Tailwind tokens for primary elements. Status colors use standard Tailwind (amber, green, red, blue).

**Icons** from lucide-react: `Search, Eye, CheckCircle, XCircle, RefreshCcw, AlertTriangle, DollarSign, Calendar, X, Clock, Shield`.

**Error handling:** Same pattern as AdminPayments -- show error banner if fetchRefunds fails, empty catches for stats fetch.

Export default AdminRefunds.
  </action>
  <verify>
Check file exists and has correct structure:
- Contains `const AdminRefunds` function component
- Contains `fetchRefunds` and `fetchStats` functions
- Contains `handleApprove` and `handleReject` functions
- Imports from `lucide-react` and `../../lib/axios`
- Uses `DEFAULT_PAGE_SIZE` from constants
- Has `export default AdminRefunds`
  </verify>
  <done>
AdminRefunds.jsx page exists with: stats cards (total, pending, processing, processed, rejected), filterable/searchable table of refund requests, detail modal, approve/reject actions with confirmation, pagination, loading skeletons, error handling. Follows AdminPayments.jsx pattern exactly for consistent admin panel UX.
  </done>
</task>

<task type="auto">
  <name>Task 2: Mount AdminRefunds route in App.jsx</name>
  <files>
    kalasetu-frontend/src/App.jsx
  </files>
  <action>
**1. Add import for AdminRefunds:**

Near the other admin page imports (around line 49-56 where AdminPayments, AdminBookings, etc. are imported), add:
```javascript
import AdminRefunds from './pages/admin/AdminRefunds';
```

Note: AdminPayments and other admin pages use direct imports (not lazy), so do the same for AdminRefunds.

**2. Add route for AdminRefunds:**

Find the admin routes section in the Routes tree (the section wrapped in `AdminAuthProvider` > `AdminLayout`). Add the refunds route adjacent to the existing payments route:

```jsx
<Route path="refunds" element={<AdminRefunds />} />
```

Place it after the `payments` route and before the `bookings` route for logical ordering.

**3. Verify AdminLayout sidebar:**

Read `kalasetu-frontend/src/components/admin/AdminLayout.jsx` to check if the sidebar navigation includes links. If the sidebar has navigation items, add a "Refunds" link pointing to `/admin/refunds`. If the sidebar dynamically generates from a list, add the refunds entry to that list.

If the sidebar has no explicit nav items or gets them from a config, just add the route -- the page will be accessible via direct URL and can be linked later.
  </action>
  <verify>
Run frontend lint check: `cd kalasetu-frontend && npx eslint src/pages/admin/AdminRefunds.jsx src/App.jsx --no-error-on-unmatched-pattern 2>&1 | head -20`

Verify App.jsx contains the AdminRefunds import and route by checking the file.
  </verify>
  <done>
AdminRefunds page is accessible at /admin/refunds in the admin panel. Route is mounted alongside other admin routes (payments, bookings, etc.) in App.jsx. Admin sidebar updated if applicable.
  </done>
</task>

</tasks>

<verification>
1. AdminRefunds.jsx exists with complete UI: stats, filters, table, pagination, modal, actions
2. AdminRefunds route is mounted at /admin/refunds in App.jsx
3. No ESLint errors in AdminRefunds.jsx
4. Page calls correct API endpoints: GET /api/admin/refunds, GET /api/admin/refunds/stats, POST /api/admin/refunds/:id/approve, POST /api/admin/refunds/:id/reject
5. UI uses brand colors (brand-*) and follows AdminPayments layout pattern
6. Status badges use appropriate colors for each refund status
</verification>

<success_criteria>
- AdminRefunds.jsx renders stats cards, filterable table, detail modal, approve/reject actions
- Route accessible at /admin/refunds in the admin panel
- Page follows existing AdminPayments.jsx patterns for consistent UX
- All API calls properly handle loading, error, and success states
- Approve shows confirmation, reject requires reason input
- Pagination works with the same component pattern
</success_criteria>

<output>
After completion, create `.planning/phases/02-refund-support/02-03-SUMMARY.md`
</output>
